<%- include('../layout-header') %>
<div class="container py-5">
  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="mb-3 text-primary">æ™ºèƒ½ä½œä¸šè¾…å¯¼ç³»ç»Ÿ</h2>
      <p class="lead">AIé©±åŠ¨çš„ä½œä¸šåˆ†æä¸åˆ†å­¦ç§‘è¾…å¯¼ï¼ŒåŠ©åŠ›å­¦ç”Ÿç‹¬ç«‹æ€è€ƒï¼Œèµ‹èƒ½å®¶é•¿ç§‘å­¦è¾…å¯¼ã€‚</p>
    </div>
  </div>
  <!-- é¢˜ç›®è¾“å…¥åŒº -->
<div class="row mb-4">
  <div class="col-md-8 offset-md-2">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="card-title">1. è¾“å…¥ä½ çš„ä½œä¸šé¢˜ç›®</h5>
        <textarea id="questionText" class="form-control mb-2" rows="3" placeholder="è¯·ç²˜è´´æˆ–è¾“å…¥é¢˜ç›®å†…å®¹"></textarea>

        <!-- ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ -->
        <div class="mb-2">
          <label for="imageUpload" class="form-label">æˆ–è€…ä¸Šä¼ ä½ çš„ä½œä¸šç…§ç‰‡</label>
          <input class="form-control" type="file" id="imageUpload" accept="image/*">
          <div class="form-text text-muted small">åˆ«æ‹…å¿ƒï¼Œæˆ‘ä¸ä¼šå‘Šè¯‰ä½ çš„é“…ç¬”ç›’ä½ ä¸ä¼šåšè¿™é¢˜ ğŸ˜„</div>
        </div>

        <div class="input-group mb-2">
          <label class="input-group-text" for="subject">å­¦ç§‘</label>
          <select id="subject" class="form-select">
            <option value="">è‡ªåŠ¨è¯†åˆ«</option>
            <option value="æ•°å­¦">æ•°å­¦</option>
            <option value="è¯­æ–‡">è¯­æ–‡</option>
            <option value="è‹±è¯­">è‹±è¯­</option>
          </select>
          <button id="analyzeBtn" class="btn btn-primary" type="button">æ™ºèƒ½åˆ†æ</button>
        </div>
        <div id="inputError" class="text-danger small"></div>
      </div>
    </div>
  </div>
</div>

  <!-- é¢˜ç›®åˆ†æä¸åˆ†å­¦ç§‘è¾…å¯¼åŒº -->
  <div class="row mb-4" id="analysisSection" style="display:none;">
    <div class="col-md-8 offset-md-2">
      <div class="card border-success shadow-sm">
        <div class="card-body">
          <h5 class="card-title text-success">2. é¢˜ç›®åˆ†æä¸åˆ†å­¦ç§‘è¾…å¯¼</h5>
          <div id="analysisResult"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- æ¸è¿›å¼æ€ç»´å¼•å¯¼åŒº -->
  <div class="row mb-4" id="guidanceSection" style="display:none;">
    <div class="col-md-8 offset-md-2">
      <div class="card border-info shadow-sm">
        <div class="card-body">
          <h5 class="card-title text-info">3. æ¸è¿›å¼æ€ç»´å¼•å¯¼</h5>
          <div id="guidanceResult"></div>
          <button id="nextGuidanceBtn" class="btn btn-outline-info mt-2">ä¸‹ä¸€æ­¥å¼•å¯¼</button>
        </div>
      </div>
    </div>
  </div>
  <!-- å®¶é•¿è¾…å¯¼æ”¯æŒåŒº -->
  <div class="row mb-4" id="parentSection" style="display:none;">
    <div class="col-md-8 offset-md-2">
      <div class="card border-warning shadow-sm">
        <div class="card-body">
          <h5 class="card-title text-warning">4. å®¶é•¿è¾…å¯¼æ”¯æŒ</h5>
          <div id="parentSupportResult"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<%- include('../layout-footer') %>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<!-- MathJaxé…ç½®ï¼Œæ”¯æŒ$...$å†…è”å…¬å¼ -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true,
    packages: ['base', 'ams', 'noerrors', 'noundefined']
  },
  svg: { fontCache: 'global' },
  startup: {
    pageReady: () => {
      console.log('MathJax å·²åŠ è½½å®Œæˆ');
      return MathJax.startup.defaultPageReady();
    }
  },
  options: {
    enableMenu: false,
    menuOptions: {
      settings: {
        texHints: true,
        semantics: false,
        zoom: 'NoZoom',
        zscale: '200%'
      }
    }
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
let lastQuestion = '';
let lastSubject = '';
let currentStep = '';
let lastImageBase64 = '';

function renderAnalysis(data) {
  console.log('renderAnalysis æ¥æ”¶åˆ°çš„æ•°æ®:', data);
  
  let html = `<div><b>å­¦ç§‘ï¼š</b>${data.å­¦ç§‘ || ''}ã€€<b>é¢˜å‹ï¼š</b>${data.é¢˜å‹ || ''}ã€€<b>éš¾åº¦ï¼š</b>${data.éš¾åº¦ || ''}</div>`;
  
  // å¤„ç†å…³é”®ä¿¡æ¯
  if(data.å…³é”®ä¿¡æ¯) {
    if(Array.isArray(data.å…³é”®ä¿¡æ¯)) {
      html += `<div class='mt-2'><b>å…³é”®ä¿¡æ¯ï¼š</b><ul>`;
      data.å…³é”®ä¿¡æ¯.forEach(item => {
        // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ ¼å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
        html += `<li>${item}</li>`;
      });
      html += `</ul></div>`;
      console.log('å…³é”®ä¿¡æ¯æ•°ç»„:', data.å…³é”®ä¿¡æ¯);
    } else if(typeof data.å…³é”®ä¿¡æ¯ === 'object') {
      html += `<div class='mt-2'><b>å…³é”®ä¿¡æ¯ï¼š</b><ul>`;
      Object.entries(data.å…³é”®ä¿¡æ¯).forEach(([key, value]) => {
        html += `<li><b>${key}ï¼š</b>${value}</li>`;
      });
      html += `</ul></div>`;
    }
  }
  
  // å¤„ç†åˆ†å­¦ç§‘guidance - ä¿®å¤é€»è¾‘
  if(data['åˆ†å­¦ç§‘guidance'] && typeof data['åˆ†å­¦ç§‘guidance'] === 'object') {
    html += `<div class='mt-3'><b>åˆ†å­¦ç§‘è¾…å¯¼ï¼š</b>`;
    Object.entries(data['åˆ†å­¦ç§‘guidance']).forEach(([key, value]) => {
      if(Array.isArray(value)) {
        html += `<div class='mt-2'><b>${key}ï¼š</b><ul>`;
        value.forEach(item => {
          // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ ¼å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
          html += `<li>${item}</li>`;
        });
        html += `</ul></div>`;
      } else if(typeof value === 'string' && value.trim() !== '') {
        // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ ¼å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
        html += `<div class='mt-2'><b>${key}ï¼š</b>${value}</div>`;
      }
    });
    html += `</div>`;
  }
    return html;
}
function renderGuidance(data) {
  console.log('ã€renderGuidanceã€‘data:', data);
  console.log('ã€renderGuidanceã€‘data.content:', data.content);
  console.log('ã€renderGuidanceã€‘typeof data.content:', typeof data.content);
  let content = data.content || '';
  console.log('ã€renderGuidanceã€‘æœ€ç»ˆcontent:', content);
  const html = `<div><b>${data.step || ''}ï¼š</b>${content}</div>`;
  console.log('ã€renderGuidanceã€‘æœ€ç»ˆæ¸²æŸ“HTML:', html);
  return html;
}
function renderParentSupport(data) {
  let html = `<div><b>çŸ¥è¯†ç‚¹è¯´æ˜ï¼š</b>${data.knowledge || ''}</div>`;
  
  let solution = data.solution || '';
  // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ ¼å¼ï¼Œä¸éœ€è¦é¢å¤–å¤„ç†
  html += `<div class='mt-2'><b>æ ‡å‡†è§£é¢˜è¿‡ç¨‹ï¼š</b>${solution}</div>`;
  
  if(data.errorCommon) html += `<div class='mt-2'><b>å¸¸è§é”™è¯¯æé†’ï¼š</b>${data.errorCommon}</div>`;
  if(data.extension) html += `<div class='mt-2'><b>æ‹“å±•çŸ¥è¯†ï¼š</b>${data.extension}</div>`;
  if(data.talk && data.talk.length) html += `<div class='mt-2'><b>æé—®æŠ€å·§ï¼š</b>${data.talk.join('ï¼Œ')}</div>`;
  if(data.encourage && data.encourage.length) html += `<div class='mt-2'><b>é¼“åŠ±ç”¨è¯­ï¼š</b>${data.encourage.join('ï¼Œ')}</div>`;
  if(data.correct && data.correct.length) html += `<div class='mt-2'><b>çº é”™æ–¹æ³•ï¼š</b>${data.correct.join('ï¼Œ')}</div>`;
  if(data.interact && data.interact.length) html += `<div class='mt-2'><b>äº’åŠ¨å»ºè®®ï¼š</b>${data.interact.join('ï¼Œ')}</div>`;
  if(data.training && data.training.length) html += `<div class='mt-2'><b>åŸ¹è®­å»ºè®®ï¼š</b>${data.training.join('ï¼Œ')}</div>`;
  // å®¶é•¿åŸ¹è®­æ¨¡å—
  if(data.trainingConcept || data.subjectFeature || data.psychology || data.problemSolve) {
    html += `<div class='mt-4 p-3 border rounded bg-light'><b>å®¶é•¿åŸ¹è®­æ¨¡å—</b>`;
    if(data.trainingConcept) html += `<div class='mt-2'><b>è¾…å¯¼ç†å¿µï¼š</b>${data.trainingConcept}</div>`;
    if(data.subjectFeature) html += `<div class='mt-2'><b>å­¦ç§‘ç‰¹ç‚¹ï¼š</b>${data.subjectFeature}</div>`;
    if(data.psychology) html += `<div class='mt-2'><b>å¿ƒç†å¼•å¯¼ï¼š</b>${data.psychology}</div>`;
    if(data.problemSolve) html += `<div class='mt-2'><b>é—®é¢˜åº”å¯¹ï¼š</b>${data.problemSolve}</div>`;
    html += `</div>`;
  }
  return html;
}
function renderMathJax() {
  if(window.MathJax) {
    if(MathJax.typesetPromise) {
      MathJax.typesetPromise().then(() => {
      }).catch(err => {
        console.error('MathJaxæ¸²æŸ“å¤±è´¥:', err);
      });
    } else {
      if(MathJax.typeset) {
        MathJax.typeset();
      }
    }
  } else {
    console.log('MathJaxå¯¹è±¡ä¸å­˜åœ¨');
  }
}
$('#analyzeBtn').on('click', function() {
  
  const questionText = $('#questionText').val().trim();
  const subject = $('#subject').val();
  const file = $('#imageUpload')[0].files[0];

  if(!questionText && !file) {
    $('#inputError').text('è¯·è¾“å…¥é¢˜ç›®å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡');
    return;
  }
  $('#inputError').text('');
  $('#analyzeBtn').prop('disabled', true).text('åˆ†æä¸­...');
  $('#analysisSection').hide();
  $('#guidanceSection').hide();
  $('#parentSection').hide();
  

  if (file) {
    // å¦‚æœç”¨æˆ·ä¸Šä¼ äº†æ–‡ä»¶ï¼Œè½¬æˆ base64 å†å‘é€
    const reader = new FileReader();
    reader.onload = function(e) {
      const imageBase64 = e.target.result;
      lastImageBase64 = imageBase64;
      sendAnalyzeRequest({ questionText, subject, imageBase64 });
    };
    reader.readAsDataURL(file);
  } else {
    // åªæœ‰æ–‡æœ¬
    lastImageBase64 = '';
    sendAnalyzeRequest({ questionText, subject });
  }
});

function sendAnalyzeRequest(payload) {
  $.post('/homework/analyze', payload, function(data) {
    lastQuestion = payload.questionText;
    lastSubject = data.subject || payload.subject;
    currentStep = '';
    console.log('AI analyzeHomework è¿”å›å¯¹è±¡:', data);
    $('#analysisResult').html(renderAnalysis(data));
    $('#analysisSection').show();
    renderMathJax();
    getGuidance('é¢˜ç›®ç†è§£');
    getParentSupport();
  }).fail(function(xhr){
    $('#analysisResult').html('<span class="text-danger">AIåˆ†æå¤±è´¥ï¼š'+(xhr.responseJSON?.error||'æœªçŸ¥é”™è¯¯')+'</span>');
    $('#analysisSection').show();
  }).always(function(){
    $('#analyzeBtn').prop('disabled', false).text('æ™ºèƒ½åˆ†æ');
  });
}

function getGuidance(step) {
  $('#guidanceResult').html('<span class="text-secondary">æ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–å¼•å¯¼...</span>');
  $('#guidanceSection').show();
  $.post('/homework/guidance', { 
    questionText: lastQuestion, 
    currentStep: step,
    imageBase64: lastImageBase64 
  }, function(data) {
    console.log('ã€guidanceå›è°ƒã€‘AI guidance è¿”å›å¯¹è±¡:', data);
    currentStep = data.nextStep || '';
    const html = renderGuidance(data);
    console.log('ã€guidanceå›è°ƒã€‘renderGuidanceè¿”å›HTML:', html);
    $('#guidanceResult').html(html);
    renderMathJax();
    if(!data.nextStep) $('#nextGuidanceBtn').hide();
    else $('#nextGuidanceBtn').show();
  }).fail(function(xhr){
    $('#guidanceResult').html('<span class="text-danger">AIå¼•å¯¼å¤±è´¥ï¼š'+(xhr.responseJSON?.error||'æœªçŸ¥é”™è¯¯')+'</span>');
    $('#nextGuidanceBtn').hide();
  });
}
$('#nextGuidanceBtn').on('click', function(){
  if(currentStep) getGuidance(currentStep);
});
function getParentSupport() {
  $('#parentSupportResult').html('<span class="text-secondary">AIå®¶é•¿æ”¯æŒåŠ è½½ä¸­...</span>');
  $('#parentSection').show();
  $.post('/homework/parent-support', { questionText: lastQuestion, subject: lastSubject, imageBase64: lastImageBase64 }, function(data) {
    $('#parentSupportResult').html(renderParentSupport(data));
    renderMathJax();
  }).fail(function(xhr){
    $('#parentSupportResult').html('<span class="text-danger">AIå®¶é•¿æ”¯æŒå¤±è´¥ï¼š'+(xhr.responseJSON?.error||'æœªçŸ¥é”™è¯¯')+'</span>');
  });
}
</script> 